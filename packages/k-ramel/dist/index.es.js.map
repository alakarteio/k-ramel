{"version":3,"file":"index.es.js","sources":["../src/createStore/reduxFactory.js","../src/createStore/toContext.js","../src/createStore/combine.js","../src/createStore/enhanceRedux/getDevTools.js","../src/createStore/enhanceRedux/listenFactory.js","../src/createStore/enhanceRedux/enhanceRedux.js","../src/createStore/createStore.js","../src/factoryHelpers.js","../src/reaction.js"],"sourcesContent":["import factory from 'k-redux-factory'\n\nexport default (root) => {\n  const subtree = (name, path) => {\n    // first run\n    if (name === undefined) {\n      return Object\n        .keys(root)\n        .map(key => ({ [key]: subtree(key, '') }))\n        .reduce(\n          (acc, next) => ({ ...acc, ...next }),\n          {},\n        )\n    }\n\n    // other runs\n    const nextPath = `${path ? `${path}.` : ''}${name}`\n    const fullpath = `root.${nextPath}`\n    const options = eval(fullpath) // eslint-disable-line no-eval\n    const { type } = options\n\n    // - leaf\n    if (type) { // k-redux-factory\n      return factory({\n        name,\n        path,\n        prefix: (path && path.replace(/\\./g, '_')) || '',\n        ...options,\n      })\n    } else if (typeof options === 'function') { // custom reducer\n      return options\n    }\n\n    // - branch\n    return Object\n      .keys(options)\n      .map(key => ({ [key]: subtree(key, nextPath) }))\n      .reduce(\n        (acc, next) => ({ ...acc, ...next }),\n        {},\n      )\n  }\n\n  return subtree()\n}\n","const withParams = ['get', 'getBy', 'hasKey']\n\n// TODO: review this list with k-redux-factory 6.0.0\nconst keysConfig = {\n  keyValue: [\n    // actions\n    ['set', 'add', 'update', 'addOrUpdate', 'remove', 'reset'],\n    // selectors\n    ['get', 'getBy', 'getKeys', 'getAsArray', 'getLength', 'isInitialized', 'getState', 'hasKey'],\n  ],\n  simple: [\n    // actions\n    ['set', 'update', 'reset'],\n    // selectors\n    ['get', 'isInitialized'],\n  ],\n}\nkeysConfig.simpleObject = keysConfig.simple\nkeysConfig['simple.object'] = keysConfig.simple\nkeysConfig['simple.array'] = keysConfig.simple\nkeysConfig['simple.bool'] = keysConfig.simple\nkeysConfig['simple.string'] = keysConfig.simple\n\nexport default (root, store) => {\n  const subcontext = (name, path) => {\n    // first run\n    if (name === undefined) {\n      return Object\n        .keys(root)\n        .map(key => ({ [key]: subcontext(key, '') }))\n        .reduce(\n          (acc, next) => ({ ...acc, ...next }),\n          {},\n        )\n    }\n\n    // other runs\n    const nextPath = `${path ? `${path}.` : ''}${name}`\n    const fullpath = `root.${nextPath}`\n    const reducer = eval(fullpath) // eslint-disable-line no-eval\n\n    // - leaf\n    if (reducer.krfType !== undefined) {\n      const keys = keysConfig[reducer.krfType]\n      const [actions, selectors] = keys\n\n      const actionsObject = actions\n        .map((action) => {\n          const legacyAction = reducer[action]\n\n          return {\n            [action]: (...args) => store.dispatch(legacyAction(...args)),\n          }\n        })\n        .reduce(\n          (acc, next) => ({ ...acc, ...next }),\n          {},\n        )\n      const selectorsObject = selectors\n        .map((selector) => {\n          const legacySelector = reducer[selector]\n\n          return {\n            [selector]: (...args) => {\n              if (withParams.includes(selector)) return legacySelector(...args)(store.getState())\n              return legacySelector(store.getState())\n            },\n          }\n        })\n        .reduce(\n          (acc, next) => ({ ...acc, ...next }),\n          {},\n        )\n\n      return Object.assign(reducer, actionsObject, selectorsObject)\n    }\n\n    // - branch\n    return Object\n      .keys(reducer)\n      .map(key => ({ [key]: subcontext(key, nextPath) }))\n      .reduce(\n        (acc, next) => ({ ...acc, ...next }),\n        {},\n      )\n  }\n\n  return subcontext()\n}\n","import { combineReducers } from 'redux'\n\nexport default (root) => {\n  const subcombine = (current) => {\n    const reducers = Object\n      .keys(current)\n      .map((key) => {\n        const cur = current[key]\n        if (typeof cur === 'function') return ({ [key]: cur })\n        return ({ [key]: subcombine(cur) })\n      })\n      .reduce(\n        (acc, curr) => ({ ...acc, ...curr }),\n        {},\n      )\n\n    return combineReducers(reducers)\n  }\n\n  return subcombine(root)\n}\n","const getReduxDevToolsEnhancer = name => window.devToolsExtension({ name })\n\nexport default (options) => {\n  const { name, devtools } = options\n\n  // no devtool enable\n  if (!devtools || !window || !window.devToolsExtension) return undefined\n\n  // return enhancer with devtools\n  return getReduxDevToolsEnhancer(name)\n}\n","import { applyMiddleware } from 'redux'\n\nexport default (rootListeners = [], drivers, withDevTools) => {\n  // k-ramel store\n  let innerStore\n\n  // k-ramel listners\n  let innerListeners = [rootListeners]\n\n  return {\n    // this setter is needed since the middleware is pass to redux\n    // createStore, and then BEFORE, we have store instanciated\n    setStore: (store) => {\n      innerStore = store\n    },\n\n    // this is to add new listeners\n    addListeners: (listeners) => {\n      innerListeners = [...innerListeners, listeners]\n    },\n\n    // this is to remove listeners\n    removeListeners: (listeners) => {\n      innerListeners = innerListeners.filter(l => l !== listeners)\n    },\n\n    // redux middleware\n    enhancer: applyMiddleware(() => next => (action) => {\n      const innerAction = withDevTools ? (action.action || action) : action\n\n      // dispatch action\n      const res = next(action)\n\n      // trigger listeners\n      innerListeners\n        .forEach((listeners) => {\n          try {\n            listeners.forEach((listener) => {\n              listener(innerAction, innerStore, innerStore.drivers)\n            })\n          } catch (exception) {\n            innerStore.dispatch({\n              type: '@@krml/EXCEPTION',\n              payload: {\n                from: action,\n                exception,\n                message: exception.message,\n              },\n            })\n          }\n        })\n\n      // return action result\n      return res\n    }),\n  }\n}\n","import { compose } from 'redux'\nimport getDevTools from './getDevTools'\nimport listenFactory from './listenFactory'\n\n/* eslint-env browser */\nexport default (options) => {\n  const { listeners, drivers, enhancer } = options\n\n  // devtools\n  const devtools = getDevTools(options)\n\n  // add custom listeners extension\n  const listen = listenFactory(listeners, drivers, !!devtools)\n\n  const enhancers = [\n    enhancer,\n    devtools,\n    listen.enhancer,\n  ].filter(Boolean)\n\n  // add this middleware to enhancer\n  return { enhancer: compose(...enhancers), listen }\n}\n","import { createStore, compose } from 'redux'\nimport http from '@k-ramel/driver-http'\nimport reduxFactory from './reduxFactory'\nimport toContext from './toContext'\nimport combine from './combine'\nimport enhanceRedux from './enhanceRedux'\n\nconst defaultOptions = {\n  hideRedux: true,\n  enhancer: undefined,\n  init: {},\n  listeners: undefined,\n  devtools: true,\n  name: 'store',\n  drivers: {\n    http: http(),\n  },\n}\n\nexport default (definition, options = defaultOptions) => {\n  // options\n  const innerOptions = {\n    ...defaultOptions,\n    ...options,\n    drivers: {\n      ...defaultOptions.drivers,\n      ...options.drivers,\n    },\n  }\n  const { init, hideRedux, drivers } = innerOptions\n  const definitionWithDrivers = { ...definition }\n\n  // use drivers\n  const driversEnhancers = []\n  const driversInits = []\n  Object.values(drivers)\n    .forEach((driver) => {\n      // bind reducer to store definition\n      if (driver.getReducer) {\n        const { reducer, path } = driver.getReducer() // eslint-disable-line no-unused-vars\n        eval(`definitionWithDrivers${path.length > 0 ? '.' : ''}${path}=reducer`) // eslint-disable-line no-eval\n      }\n\n      // add enhancer\n      if (driver.getEnhancer) driversEnhancers.push(driver.getEnhancer())\n\n      // add init\n      if (driver.init) driversInits.push(driver.init)\n    })\n\n  // add all driver enhancers\n  if (innerOptions.enhancer) driversEnhancers.push(innerOptions.enhancer)\n  innerOptions.enhancer = compose(...driversEnhancers)\n\n  // this is reducer exports (action/selectors)\n  let reducerTree = reduxFactory(definitionWithDrivers)\n\n  // instanciate the listen middleware and prepare redux enhancers\n  const { enhancer, listen } = enhanceRedux(innerOptions)\n\n  // this is the redux store\n  const reduxStore = createStore(\n    combine(reducerTree),\n    init,\n    enhancer,\n  )\n\n  // convert to a contextualized version\n  if (hideRedux) {\n    reducerTree = toContext(reducerTree, reduxStore)\n  }\n\n  // store (our own)\n  const store = {\n    ...reducerTree,\n    ...reduxStore,\n    listeners: {\n      add: listen.addListeners,\n      remove: listen.removeListeners,\n    },\n  }\n\n  // store with driver\n  store.drivers = Object.keys(drivers)\n    .reduce(\n      (acc, driver) => ({ ...acc, [driver]: drivers[driver].getDriver(store) }),\n      {},\n    )\n\n  // custom dispatch\n  const reduxDispatch = store.dispatch\n  store.dispatch = (action, ...args) => {\n    if (typeof action === 'string') return reduxDispatch({ type: action })\n    return reduxDispatch(action, ...args)\n  }\n\n  // pass store to listen (after it has been created)\n  listen.setStore(store)\n\n  // init drivers\n  driversInits.forEach(driverInit => driverInit(store))\n\n  return store\n}\n","// TODO: documentation\nexport const types = {\n  array: params => ({ ...params, type: 'simple.array' }),\n  bool: params => ({ ...params, type: 'simple.bool' }),\n  string: params => ({ ...params, type: 'simple.string' }),\n  object: params => ({ ...params, type: 'simple.object' }),\n  keyValue: params => ({ ...params, type: 'keyValue' }),\n}\n\nexport const keyValue = (params) => {\n  console.warn('/k-ramel/ You are using a deprecated \"keyValue\" import. We recommend using `types` : types.object, types.array, types.bool, types.string or types.keyValue')\n  return { ...params, type: 'keyValue' }\n}\n\nexport const simpleObject = (params) => {\n  console.warn('/k-ramel/ You are using a deprecated \"simpleObject\" import. We recommend using `types` : types.object, types.array, types.bool, types.string or types.keyValue')\n\n  return { ...params, type: 'simple.object' }\n}\n","import { isRegExp, isString, isFunction } from 'lodash'\n\nconst isMatching = (action, store) => matcher => ( // test matching\n  // to a string\n  (\n    isString(matcher) &&\n    action.type === matcher\n  )\n  // to a function\n  || (\n    isFunction(matcher) &&\n    matcher(action, store)\n  )\n  // to a regexp\n  || (\n    isRegExp(matcher) &&\n    action.type.match(matcher)\n  )\n)\n\nexport const when = (...matchers) => callback => (action, store, drivers) => {\n  const match = matchers\n    .reduce((acc, curr) => acc && isMatching(action, store)(curr), true)\n\n  if (match) return callback(action, store, drivers)\n  return false\n}\n\nexport const reaction = fn => Object.assign(\n  fn,\n  { when: (...args) => when(...args)(fn) },\n)\n\nexport const reactions = fns => Object.keys(fns)\n  .reduce((acc, curr) => ({ ...acc, [curr]: reaction(fns[curr]) }), {})\n"],"names":["root","subtree","name","path","undefined","Object","keys","map","key","reduce","acc","next","nextPath","fullpath","options","eval","type","factory","replace","withParams","keysConfig","simpleObject","simple","store","subcontext","reducer","krfType","actions","selectors","actionsObject","action","legacyAction","dispatch","selectorsObject","selector","legacySelector","includes","getState","assign","subcombine","current","reducers","cur","curr","combineReducers","getReduxDevToolsEnhancer","window","devToolsExtension","devtools","rootListeners","withDevTools","innerStore","innerListeners","listeners","filter","l","applyMiddleware","innerAction","res","forEach","listener","drivers","exception","message","enhancer","getDevTools","listen","listenFactory","enhancers","Boolean","compose","defaultOptions","http","definition","innerOptions","init","hideRedux","definitionWithDrivers","driversEnhancers","driversInits","values","driver","getReducer","length","getEnhancer","push","reducerTree","reduxFactory","enhanceRedux","reduxStore","createStore","combine","toContext","addListeners","removeListeners","getDriver","reduxDispatch","args","setStore","driverInit","types","params","keyValue","warn","isMatching","matcher","isRegExp","match","when","matchers","callback","reaction","fn","reactions","fns"],"mappings":"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"}