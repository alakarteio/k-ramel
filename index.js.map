{"version":3,"file":"index.js","sources":["src/createStore/reduxFactory.js","src/createStore/toContext.js","src/createStore/combine.js","src/createStore/enhanceRedux/addDevTools.js","src/createStore/enhanceRedux/listenFactory.js","src/createStore/enhanceRedux/enhanceRedux.js","src/createStore/drivers/http/http.js","src/createStore/createStore.js","src/factoryHelpers.js","src/reaction.js"],"sourcesContent":["import factory from 'k-redux-factory'\n\nexport default (root) => {\n  const subtree = (name, path) => {\n    // first run\n    if (name === undefined) {\n      return Object\n        .keys(root)\n        .map(key => ({ [key]: subtree(key, '') }))\n        .reduce(\n          (acc, next) => ({ ...acc, ...next }),\n          {},\n        )\n    }\n\n    // other runs\n    const nextPath = `${path ? `${path}.` : ''}${name}`\n    const fullpath = `root.${nextPath}`\n    const options = eval(fullpath) // eslint-disable-line no-eval\n    const { type } = options\n\n    // - leaf\n    if (type) { // k-redux-factory\n      return factory({\n        name,\n        path,\n        prefix: (path && path.replace(/\\./g, '_')) || '',\n        ...options,\n      })\n    } else if (typeof options === 'function') { // custom reducer\n      return options\n    }\n\n    // - branch\n    return Object\n      .keys(options)\n      .map(key => ({ [key]: subtree(key, nextPath) }))\n      .reduce(\n        (acc, next) => ({ ...acc, ...next }),\n        {},\n      )\n  }\n\n  return subtree()\n}\n","const withParams = ['get', 'getBy', 'hasKey']\n\nconst keysConfig = {\n  keyValue: [\n    // actions\n    ['set', 'add', 'update', 'addOrUpdate', 'replace', 'remove', 'orderBy', 'reset'],\n    // selectors\n    ['get', 'getBy', 'getKeys', 'getAsArray', 'getLength', 'isInitialized', 'getState', 'hasKey'],\n  ],\n  simpleObject: [\n    // actions\n    ['set', 'update', 'reset'],\n    // selectors\n    ['get', 'isInitialized'],\n  ],\n}\n\nexport default (root, store) => {\n  const subcontext = (name, path) => {\n    // first run\n    if (name === undefined) {\n      return Object\n        .keys(root)\n        .map(key => ({ [key]: subcontext(key, '') }))\n        .reduce(\n          (acc, next) => ({ ...acc, ...next }),\n          {},\n        )\n    }\n\n    // other runs\n    const nextPath = `${path ? `${path}.` : ''}${name}`\n    const fullpath = `root.${nextPath}`\n    const reducer = eval(fullpath) // eslint-disable-line no-eval\n\n    // - leaf\n    if (reducer.krfType !== undefined) {\n      const keys = keysConfig[reducer.krfType]\n      const [actions, selectors] = keys\n\n      const actionsObject = actions\n        .map((action) => {\n          const legacyAction = reducer[action]\n\n          return {\n            [action]: (...args) => store.dispatch(legacyAction(...args)),\n          }\n        })\n        .reduce(\n          (acc, next) => ({ ...acc, ...next }),\n          {},\n        )\n      const selectorsObject = selectors\n        .map((selector) => {\n          const legacySelector = reducer[selector]\n\n          return {\n            [selector]: (...args) => {\n              if (withParams.includes(selector)) return legacySelector(...args)(store.getState())\n              return legacySelector(store.getState())\n            },\n          }\n        })\n        .reduce(\n          (acc, next) => ({ ...acc, ...next }),\n          {},\n        )\n\n      return Object.assign(reducer, actionsObject, selectorsObject)\n    }\n\n    // - branch\n    return Object\n      .keys(reducer)\n      .map(key => ({ [key]: subcontext(key, nextPath) }))\n      .reduce(\n        (acc, next) => ({ ...acc, ...next }),\n        {},\n      )\n  }\n\n  return subcontext()\n}\n","import { combineReducers } from 'redux'\n\nexport default (root) => {\n  const subcombine = (current) => {\n    const reducers = Object\n      .keys(current)\n      .map((key) => {\n        const cur = current[key]\n        if (typeof cur === 'function') return ({ [key]: cur })\n        return ({ [key]: subcombine(cur) })\n      })\n      .reduce(\n        (acc, curr) => ({ ...acc, ...curr }),\n        {},\n      )\n\n    return combineReducers(reducers)\n  }\n\n  return subcombine(root)\n}\n","import { compose } from 'redux'\n\nconst getReduxDevToolsEnhancer = name => window.devToolsExtension({ name })\n\nexport default (options) => {\n  const { name, devtools, enhancer } = options\n\n  // no devtool enable\n  if (!devtools || !window || !window.devToolsExtension) return enhancer\n\n  // return enhancer with devtools\n  const reduxDevtoolsEnhancer = getReduxDevToolsEnhancer(name)\n  if (enhancer) return compose(enhancer, reduxDevtoolsEnhancer)\n  return reduxDevtoolsEnhancer\n}\n","export default (listeners, drivers) => {\n  // k-ramel store\n  let innerStore\n\n  // k-ramel drivers (enhanced with store)\n  let innerDrivers\n\n  return {\n    // this setter is needed since the middleware is pass to redux\n    // createStore, and then BEFORE, we have store instanciated\n    setStore: (store) => {\n      innerStore = store\n      innerDrivers = Object\n        .keys(drivers)\n        .reduce(\n          (acc, driver) => ({ ...acc, [driver]: drivers[driver](store) }),\n          {},\n        )\n    },\n\n    // redux middleware\n    middleware: () => next => (action) => {\n      // dispatch action\n      const res = next(action)\n\n      // trigger listeners\n      listeners.forEach((listener) => { listener(action, innerStore, innerDrivers) })\n\n      // return action result\n      return res\n    },\n  }\n}\n","import { compose, applyMiddleware } from 'redux'\nimport addDevTools from './addDevTools'\nimport listenFactory from './listenFactory'\n\n/* eslint-env browser */\nexport default (options) => {\n  const { listeners, drivers } = options\n  let { enhancer } = options\n\n  // add redux-devtools extension (if necessary)\n  enhancer = addDevTools(options)\n\n  // add custom listeners extension\n  if (listeners) {\n    const listen = listenFactory(listeners, drivers)\n\n    // add this middleware to enhancer\n    const middleware = applyMiddleware(listen.middleware)\n    if (enhancer) return { enhancer: compose(middleware, enhancer), listen }\n\n    return { enhancer: middleware, listen }\n  }\n\n  return { enhancer }\n}\n","const dispatchFactory = store => name => method =>\n  (event, payload, status) => store.dispatch({ type: `@@http/${name}>${method}>${event}`, payload, status })\n\nexport default (store) => {\n  const innerHeaders = {}\n\n  const driver = (name) => {\n    const ownFetch = async (url, options = {}, ...args) => {\n      // options\n      const { method = 'GET' } = options\n      const headers = { ...innerHeaders, ...options.headers }\n      const innerOptions = { ...options, headers }\n\n      // dispatcher\n      const dispatch = dispatchFactory(store)(name)(method)\n\n      // request\n      let data\n      let raw\n      dispatch('STARTED')\n      try {\n        raw = await (global || window).fetch(url, innerOptions, ...args)\n        data = raw\n\n        if (raw.headers && raw.headers.get('Content-Type') && raw.headers.get('Content-Type').includes('json')) {\n          data = await raw.json()\n        }\n      } catch (ex) {\n        dispatch('FAILED', ex, (raw || {}).status)\n        return ex\n      }\n\n      const { status } = raw\n      if (status >= 400 || status < 200) {\n        dispatch('FAILED', data, status)\n      } else {\n        dispatch('ENDED', data, status)\n      }\n\n      return data\n    }\n\n    // methods helpers\n    ['GET', 'POST', 'HEAD', 'PUT', 'DELETE', 'OPTIONS', 'CONNECT']\n      .forEach((method) => {\n        ownFetch[method.toLowerCase()] = (url, data, options = {}) => {\n          const { headers = {} } = options\n          let innerOptions = options\n\n          // attach data as JSON object\n          if (data && ['object', 'array'].includes(typeof data)) {\n            if (!headers['Content-Type']) innerOptions = { ...innerOptions, headers: { ...headers, 'Content-Type': 'application/json' } }\n\n            innerOptions = { ...innerOptions, body: JSON.stringify(data) }\n          }\n\n          // set method\n          innerOptions = { ...innerOptions, method }\n\n          return ownFetch(url, innerOptions)\n        }\n      })\n\n    return ownFetch\n  }\n\n  // custom helpers\n  driver.setAuthorization = (authorization) => {\n    innerHeaders.Authorization = authorization\n  }\n\n  return driver\n}\n","import { createStore } from 'redux'\nimport reduxFactory from './reduxFactory'\nimport toContext from './toContext'\nimport combine from './combine'\nimport enhanceRedux from './enhanceRedux'\nimport drivers from './drivers'\n\nconst defaultOptions = {\n  hideRedux: true,\n  enhancer: undefined,\n  init: {},\n  listeners: undefined,\n  devtools: true,\n  name: 'store',\n  drivers,\n}\n\nexport default (definition, options = defaultOptions) => {\n  // options\n  const innerOptions = {\n    ...defaultOptions,\n    ...options,\n    drivers: {\n      ...defaultOptions.drivers,\n      ...options.drivers,\n    },\n  }\n  const { init, hideRedux } = innerOptions\n\n  // this is reducer exports (action/selectors)\n  let reducerTree = reduxFactory(definition)\n\n  // instanciate the listen middleware and prepare redux enhancers\n  const { enhancer, listen } = enhanceRedux(innerOptions)\n\n  // this is the redux store\n  const reduxStore = createStore(\n    combine(reducerTree),\n    init,\n    enhancer,\n  )\n\n  // convert to a contextualized version\n  if (hideRedux) {\n    reducerTree = toContext(reducerTree, reduxStore)\n  }\n\n  // exported store (our own)\n  const store = {\n    ...reducerTree,\n    ...reduxStore,\n  }\n\n  // custom dispatch\n  const reduxDispatch = store.dispatch\n  store.dispatch = (action, ...args) => {\n    if (typeof action === 'string') return reduxDispatch({ type: action })\n    return reduxDispatch(action, ...args)\n  }\n\n  // pass store to listen (after it has been created)\n  if (listen) listen.setStore(store)\n\n  return store\n}\n","export const keyValue = params => ({ ...params, type: 'keyValue' })\nexport const simpleObject = params => ({ ...params, type: 'simpleObject' })\n","import { isRegExp, isString, isFunction } from 'lodash'\n\nconst isMatching = (action, store) => matcher => ( // test matching\n  // to a string\n  (\n    isString(matcher) &&\n    action.type === matcher\n  )\n  // to a function\n  || (\n    isFunction(matcher) &&\n    matcher(action, store)\n  )\n  // to a regexp\n  || (\n    isRegExp(matcher) &&\n    action.type.match(matcher)\n  )\n)\n\nexport const when = (...matchers) => callback => (action, store, drivers) => {\n  const match = matchers\n    .map(isMatching(action, store))\n    .reduce((acc, curr) => acc && curr, true)\n\n  if (match) return callback(action, store, drivers)\n  return false\n}\n\nexport const reaction = fn => Object.assign(\n  fn,\n  { when: (...args) => when(...args)(fn) },\n)\n\nexport const reactions = fns => Object.keys(fns)\n  .reduce((acc, curr) => ({ ...acc, [curr]: reaction(fns[curr]) }), {})\n"],"names":["root","subtree","name","path","undefined","Object","keys","map","key","reduce","acc","next","nextPath","fullpath","options","eval","type","factory","replace","withParams","keysConfig","store","subcontext","reducer","krfType","actions","selectors","actionsObject","action","legacyAction","dispatch","selectorsObject","selector","legacySelector","includes","getState","assign","subcombine","current","reducers","cur","curr","combineReducers","getReduxDevToolsEnhancer","window","devToolsExtension","devtools","enhancer","reduxDevtoolsEnhancer","compose","listeners","drivers","innerStore","innerDrivers","driver","res","forEach","listener","addDevTools","listen","listenFactory","middleware","applyMiddleware","dispatchFactory","event","payload","status","method","innerHeaders","ownFetch","url","args","headers","global","fetch","innerOptions","raw","get","json","data","toLowerCase","Content-Type","body","JSON","stringify","setAuthorization","authorization","Authorization","defaultOptions","definition","init","hideRedux","reducerTree","reduxFactory","enhanceRedux","reduxStore","createStore","combine","toContext","reduxDispatch","setStore","keyValue","params","simpleObject","isMatching","matcher","isRegExp","match","when","matchers","callback","reaction","fn","reactions","fns"],"mappings":"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"}